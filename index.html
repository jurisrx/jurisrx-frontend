<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat with States</title>
    <style>
      body, html {
        margin: 0; padding: 0; height: 100%;
        font-family: sans-serif;
        background: #f7f7f8;
      }

      .top-bar {
        position: fixed;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 600px;
        background-color: #fff;
        padding: 12px 16px;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        z-index: 1000;
        display: flex;
        align-items: center;
      }

      select {
        flex: 1;
        padding: 10px 16px;
        font-size: 15px;
        border-radius: 18px;
        border: 1px solid #ccc;
        outline: none;
        cursor: pointer;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image:
          linear-gradient(45deg, transparent 50%, gray 50%),
          linear-gradient(135deg, gray 50%, transparent 50%),
          linear-gradient(to right, #ccc, #ccc);
        background-position:
          calc(100% - 20px) calc(1em + 2px),
          calc(100% - 15px) calc(1em + 2px),
          calc(100% - 25px) 0.5em;
        background-size: 5px 5px, 5px 5px, 1px 1.5em;
        background-repeat: no-repeat;
      }

      .chat-container {
        max-width: 600px;
        margin: 0 auto;
        height: calc(100vh - 60px - 50px);
        padding-top: 60px;
        padding-bottom: 200px;
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        position: relative;
      }

      .message {
        max-width: 70%;
        padding: 10px 14px;
        border-radius: 18px;
        font-size: 15px;
        line-height: 1.4;
        white-space: pre-wrap;
        margin: 6px 12px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }

      .user-message {
        background-color: #daf8cb;
        border-bottom-right-radius: 4px;
        align-self: flex-end;
      }

      .ai-message {
        background-color: #fff;
        border-bottom-left-radius: 4px;
        align-self: flex-start;
      }

      .nav-buttons {
        position: fixed;
        bottom: 160px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        justify-content: center;
        gap: 75px;
        z-index: 1000;
      }

      .nav-buttons a {
        width: 55px;
        height: 45px;
        background-color: #000;
        border-radius: 35%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        transition: background 0.2s ease;
      }

      .nav-buttons a:hover {
        background-color: #333;
      }

      .nav-buttons svg {
        width: 20px;
        height: 20px;
        stroke: #fff;
        stroke-width: 2;
      }

      .input-area {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 600px;
        background-color: #fff;
        border-top: 1px solid #ddd;
        padding: 12px 16px;
        display: flex;
        box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        z-index: 1000;
        border-radius: 16px;
      }

      textarea {
        flex: 1;
        resize: none;
        font-size: 15px;
        padding: 10px;
        border-radius: 18px;
        border: 1px solid #ccc;
        outline: none;
        font-family: sans-serif;
      }

      button {
        margin-left: 12px;
        padding: 10px 16px;
        border-radius: 18px;
        border: none;
        background-color: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      button svg {
        display: block;
      }

      /* Loading indicator */
      #loadingIndicator {
        position: fixed;
        bottom: 140px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 8px 16px;
        border-radius: 12px;
        font-style: italic;
        font-size: 14px;
        display: none;
        z-index: 1001;
      }
    </style>
  </head>
  <body>
    <div class="top-bar">
      <select id="stateSelect" aria-label="Select a US state">
        <option value="" disabled selected>Select a state</option>
        <option value="indiana">Indiana</option>
        <option value="tennessee">Tennessee</option>
      </select>
    </div>

    <div class="chat-container" id="chatWindow"></div>

    <div class="nav-buttons">
      <a href="/user/subscription" aria-label="Subscription">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </a>
      <a href="/user" aria-label="Home">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9.5L12 4l9 5.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V9.5z" />
        </svg>
      </a>
      <a href="/user/study" aria-label="Study">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="16" rx="2" />
          <path d="M7 4v16M17 4v16" />
        </svg>
      </a>
    </div>

    <div class="input-area">
      <textarea id="inputBox" rows="1" placeholder="Type your message..."></textarea>
      <button id="sendBtn" aria-label="Send">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </button>
    </div>

    <div id="loadingIndicator">JurisRx is quering legal documents...</div>

    <script>
      const backendUrl = 'https://jurisrx-backend.onrender.com/ask';

      const chatWindow = document.getElementById('chatWindow');
      const inputBox = document.getElementById('inputBox');
      const sendBtn = document.getElementById('sendBtn');
      const stateSelect = document.getElementById('stateSelect');
      const loadingIndicator = document.getElementById('loadingIndicator');

      function appendMessage(text, from) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message');
        msgDiv.classList.add(from === 'user' ? 'user-message' : 'ai-message');

        if(from === 'ai') {
          // Basic formatting: convert **bold** to <strong> for AI messages
          const formattedText = text.replace(/\*\*(.+?)\*\*/g, (_, p1) => `<strong>${p1}</strong>`);
          msgDiv.innerHTML = formattedText;
        } else {
          msgDiv.textContent = text;
        }

        chatWindow.appendChild(msgDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      function scrollChatToBottom() {
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      appendMessage('Hello! Ask me anything.', 'ai');

      sendBtn.addEventListener('click', sendMessage);
      inputBox.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      stateSelect.addEventListener('change', () => {
        appendMessage(`You selected: ${stateSelect.options[stateSelect.selectedIndex].text}`, 'ai');
        scrollChatToBottom();
      });

      async function sendMessage() {
        const state = stateSelect.value;
        const userText = inputBox.value.trim();

        if (!state) {
          alert('Please select a state.');
          return;
        }
        if (!userText) return;

        appendMessage(userText, 'user');
        inputBox.value = '';
        scrollChatToBottom();

        // Disable send button and show loading indicator
        sendBtn.disabled = true;
        loadingIndicator.style.display = 'block';

        try {
          const response = await fetch(backendUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ state, question: userText }),
          });

          if (!response.ok) throw new Error(`Server error: ${response.statusText}`);

          const data = await response.json();
          appendMessage(data.answer || 'No answer available.', 'ai');
        } catch (error) {
          appendMessage('Error: ' + error.message, 'ai');
        } finally {
          // Re-enable send button and hide loading indicator
          sendBtn.disabled = false;
          loadingIndicator.style.display = 'none';
          scrollChatToBottom();
        }
      }
    </script>
  </body>
</html>
